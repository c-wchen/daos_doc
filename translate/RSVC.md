# 复制服务

模块`rsvc`实现了一个通用的复制服务框架。在专注于模块`rsvc`之前，这个文件涵盖了一般的服务复制。

## 介绍

某些DAOS RPC服务，例如池服务(`pool_svc`)和容器服务(`cont_svc`)，在Raft中使用状态机方法进行复制。这些服务中的每一个都可以容忍其少数副本的故障。通过将其副本分布到不同的故障域，服务可以具有高可用性。由于这种复制方法是自包含的，因为它只需要本地持久存储和点对点不可靠消息传递，而不需要任何外部配置管理服务，因此这些服务对于引导DAOS系统以及管理轻量级I/O复制协议的配置是必需的。

### 架构

RPC服务根据其当前的**服务状态** *(或仅仅**状态 **)处理传入的** 服务请求 **(或仅仅 **请求 **)。因此，复制服务就是复制其状态，以便根据所有先前请求所达到的状态来处理每个请求。

服务的状态通过Raft日志复制。该服务将请求转换为状态查询和确定的状态更新。在应用到状态之前，所有状态更新首先提交到Raft日志。由于Raft保证了日志副本之间的一致性，因此服务副本最终会以相同的顺序应用相同的状态更新集，并经历相同的状态历史。

Raft采用了强大的领导力设计，每个复制的服务也是如此。一届的业务负责人为同一届的Raft负责人。在服务的副本中，只有最高词条的首项可以处理请求。对于服务器端，服务代码类似于非复制RPC服务，除了处理领导层变更事件。对于客户端，服务请求必须发送到当前leader，如果还不知道当前leader，则必须搜索它。

复制服务使用模块栈实现:

[ pool_svc, cont_svc, ... ]
[ ds_rsvc ]
[                rdb                ]
[ raft ]
[                vos                ]

`pool_svc`和`cont_svc`实现各自服务的请求处理程序和领导层更改事件处理程序。它们根据` RDB `提供的关系数据库数据模型定义各自的服务状态，使用关系数据库事务实现状态查询和更新，并将它们的leadership change事件处理程序注册到`rsvc`提供的框架中。

`rdb` (`daos_srv/rdb`)使用事务实现了层次键值存储数据模型，使用Raft进行复制。它向```ds_rsvc```交付Raft领导层变更事件，使用Raft日志实现事务，并使用VOS数据模型存储服务的数据模型及其内部元数据。leader副本上的`rdb`，与VOS接口监控可用的持久存储，当空闲空间低于阈值时，在向Raft日志添加条目之前拒绝新事务，否则可能导致服务不可用(由于应用条目时成功和“空间不足”的混合失败)。它还与VOS接口，通过触发日志的旧版本(epoch)聚合来定期压缩存储。

`raft` (`rdb/raft/include/raft.h`)在库中实现了raft核心协议。它与VOS和CaRT的集成是通过回调函数在`rdb`内部完成的。

一个复制的服务客户端(例如`dc_pool`)使用`dc_rsvc`来搜索当前的服务领导者:

  [ dc_pool ]

  [ dc_rsvc ]

搜索是通过客户端维护的候选服务副本列表和服务器RPC错误响应(在某些情况下包含可能找到当前leader的提示)的组合来完成的。未运行服务的服务器返回一个错误，客户端用来将该服务器从其列表中删除。作为非leader副本的服务器会返回不同的错误，包括提示客户端(如果需要)添加到它的列表中并改变对leader的搜索。并且，`dc_rsvc`在客户机启动时和稍后当客户机的候选服务副本列表可能变为空时(例如，由于服务中的成员关系更改)，联系运行在管理服务节点上的一个DAOS服务器，以获取池的最新服务副本列表。

## 模块 rsvc

`rsvc`的主要目的是避免不同复制的服务实现之间的代码重复。使用回调密集的API是为了尽可能多地提取通用代码，甚至不惜牺牲API的简单性。这是与其他模块api设计方式的关键区别。

`rsvc`由两部分组成:

* `ds_rsvc` (`daos_srv/rsvc.h`): 服务端框架。
* `dc_rsvc` (`daos/rsvc.h`): 客户端库。

`dc_rsvc`目前仍然被称为`rsvc`。重命名将在未来的补丁中完成。