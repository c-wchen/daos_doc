分布式异步对象存储 (DAOS) 是一种开源对象存储，专为大规模分布式非易失性内存 (NVM) 而设计。 DAOS 利用下一代 NVM 技术，如 Intel© Optane™ Persistent Memory 和 NVM express (NVMe)，同时在提供事务性非阻塞 I/O 等功能的商品硬件之上呈现键值存储接口、具有自我修复、端到端数据完整性、细粒度数据控制和弹性存储的高级数据保护，以优化性能和成本。 除了本地部署外，DAOS 还可以部署在云环境中。有关云部署的更多信息，请参阅云部分的 DAOS。 包含的文档版本与 DAOS v2.2 相关联。它们还可以描述当前正在为未来的 DAOS 版本开发的功能。这些功能将被清楚地标记为这样。

# [架构](https://docs.daos.io/v2.2/overview/architecture/#architecture)

DAOS 是一种开源软件定义的横向扩展对象存储，可为应用程序提供高带宽和高 IOPS 存储容器，并支持结合模拟、数据分析和机器学习的下一代以数据为中心的工作流。

与主要为旋转媒体设计的传统存储堆栈不同，DAOS 从头开始构建以利用新的 NVM 技术，并且非常轻量级，因为它在用户空间中运行端到端 （E2E） 并具有完整绕开操作系统。DAOS 提供了从专为基于块和高延迟存储而设计的 I/O 模型到本质上支持细粒度数据访问并释放下一代存储技术性能的模型的转变。

DAOS 是一个高性能的独立容错存储层，不依赖第三方层来管理元数据和数据弹性。

## DAOS 功能

DAOS 依靠[开放结构接口](https://openfabrics.org/downloads/ofiwg/Industry_presentations/2015_HotI23/paper.pdf) （OFI） 进行低延迟通信，并将数据存储在存储类内存 （SCM） 和 NVMe 存储上。DAOS 提供了一个原生的键-数组-值存储接口，该接口提供了一个统一的存储模型，通过该模型移植特定于域的数据模型，例如 [HDF5](https://docs.daos.io/v2.2/user/hdf5/)、[MPI-IO](https://docs.daos.io/v2.2/user/mpi-io/) 和 Apache [Hadoop](https://docs.daos.io/v2.2/user/spark/)。还提供通过本机 DAOS API 实现文件和目录的 [POSIX](https://docs.daos.io/v2.2/user/filesystem/) I/O 仿真层。

记录 DAOS I/O 操作，然后将其插入到 SCM 中维护的持久索引中。每个 I/O 都使用称为 epoch 的特定时间戳进行标记，并与数据集的特定版本相关联。内部不执行读取-修改-写入操作。写入操作是非破坏性的，对对齐不敏感。读取请求后，DAOS 服务遍历持久索引并创建一个复杂的分散-收集远程直接内存访问 （RDMA） 描述符，以直接在应用程序提供的缓冲区中重建所请求版本的数据。

SCM 存储内存直接映射到 DAOS 服务的地址空间中，该服务通过直接加载/存储来管理持久索引。根据 I/O 特征，DAOS 服务可以决定将 I/O 存储在 SCM 或 NVMe 存储中。如图 2-1 所示，延迟敏感型 I/O（如应用程序元数据和字节粒度数据）通常存储在前者中，而检查点和批量数据将存储在后者中。这种方法允许 DAOS 通过将数据流式传输到 NVMe 存储并在 SCM 中维护内部元数据索引，为批量数据提供原始 NVMe 带宽。持久内存开发工具包 （PMDK） 允许管理对 SCM 的事务访问，存储性能开发工具包 （SPDK） 支持用户空间对 NVMe 设备的 I/O。

![img](https://docs.daos.io/v2.2/admin/media/image1.png)                                                                                                 图 2-1 DAOS 存储

DAOS 旨在提供：

- 任意对齐和大小下的高吞吐量和 IOPS
- 细粒度 I/O 操作，具有真正的零拷贝（绕过内核空间） I/O 到 SCM
- 通过跨存储服务器的可扩展集合通信支持大规模分布式 NVM 存储
- 非阻塞数据和元数据操作，允许 I/O 和计算重叠
- 考虑容错域的高级数据放置
- 软件管理的冗余支持复制和纠删码，并可在线重建
- 端到端数据完整性
- 可扩展的分布式事务，具有有保证的数据一致性和自动恢复
- 数据集快照
- 用于管理对存储池的访问控制的安全框架
- 软件定义的存储管理，用于通过 COTS 硬件配置、配置、修改和监控存储池
- 在DAOS数据模型上原生支持分层数据格式（HDFS），MPI-IO和POSIX命名空间
- 灾难恢复工具
- 与 Lustre 并行文件系统无缝集成
- 移动器代理，用于在 DAOS 池之间以及从并行文件系统迁移到 DAOS，反之亦然

## DAOS 系统

数据中心可能有数十万个计算实例通过可扩展的高性能网络互连，其中所有或称为存储节点的实例子集都可以直接访问 NVM 存储。DAOS 安装涉及多个组件，这些组件可以并置或分发。

DAOS 系统由*系统*名称标识，由一组连接到同一网络的 DAOS *存储节点*组成。DAOS 存储节点每个节点运行一个 DAOS *服务器*实例，进而为每个物理套接字启动一个 DAOS *引擎*进程。DAOS 服务器的成员资格记录到系统映射中，系统映射为每个*引擎*进程分配一个唯一的整数*秩*。两个不同的 DAOS 系统由两组不相交的 DAOS 服务器组成，并且彼此不协调。

DAOS *服务器*是在每个存储节点的 Linux 实例（本机在物理*节点*上或在虚拟机或容器中）上运行的多租户守护程序。其*引擎*子进程通过网络导出本地连接的 SCM 和 NVM 存储。它侦听管理端口（由 IP 地址和 TCP 端口号寻址）以及一个或多个 fabric  endpoints（由网络 URI 寻址）。DAOS 服务器通过 /etc/daos 中的 YAML 文件进行配置，包括其引擎子进程的配置。DAOS 服务器启动可以与不同的守护程序管理或编排框架集成（例如 systemd 脚本、Kubernetes 服务，甚至通过 pdsh 或 srun 等并行启动器）。

在 DAOS 引擎内部，存储跨多个*targets*进行静态分区，以优化并发性。为避免争用，每个目标都有其专用存储、自己的服务线程池及其专用网络上下文，这些上下文可以直接通过fabric寻址，而与托管在同一存储节点上的其他目标无关。

- SCM 模块在 *AppDirect 交错*模式下配置。因此，它们作为每个套接字的单个 PMem 命名空间呈现给操作系统（在 `fsdax` 模式下）。

> 注意
>
> 使用 `dax` 选项挂载 PMem 设备时，将在 dmesg 中记录以下警告：`EXT4-fs (pmem0): DAX enabled. Warning: EXPERIMENTAL, use at your own risk`自负 可以安全地忽略此警告：发出此警告是因为 DAX 尚不支持 `reflink` 文件系统功能，但 DAOS 不使用此功能。

- 当为每个引擎配置 N 个target时，每个target使用该插槽的 `fsdax` SCM 容量的 *1/N* 容量，与其他目标无关。
- 每个目标还使用连接到此插槽的 NVMe 驱动器的一小部分 NVMe 容量。例如，在具有 4 个 NVMe 磁盘和 16 个目标的引擎中，每个目标将管理单个 NVMe 磁盘的 1/4。

target不会针对存储介质故障实施任何内部数据保护机制。因此，目标是单点故障和故障单元。动态状态与每个目标相关联：其状态可以是“已启动并正在运行”，也可以是“关闭且不可用”。

目标是性能的单位。与目标关联的硬件组件（如后端存储介质、CPU 内核和网络）的功能和容量有限。

DAOS 引擎实例导出的目标数量是可配置的，并且取决于底层硬件（特别是 SCM 模块的数量和此引擎实例提供的 NVMe SSD 的数量）。作为最佳实践，引擎的目标数应是此引擎提供的 NVMe 驱动器数的整数倍。

## 软件开发工具包和工具

应用程序、用户和管理员可以通过两个不同的客户端 API 与 DAOS 系统进行交互。管理 API 提供了管理 DAOS 系统的能力，旨在与特定于供应商的存储管理和开源编排框架集成。`dmg` CLI 工具基于 DAOS 管理 API 构建。另一方面，DAOS 库 （`libdaos`） 实现了 DAOS 存储模型。它主要针对希望在 DAOS 系统中存储数据集的应用程序和 I/O 中间件开发人员。`daos` 命令等用户实用程序也基于 API 构建，以允许用户从 CLI 管理数据集。

应用程序可以直接通过原生 DAOS API、I/O 中间件库（例如 POSIX 仿真、MPI-IO、HDF5）或通过 Spark 或 TensorFlow 等已经与原生 DAOS 存储模型集成的框架访问存储在 DAOS 中的数据集。

## 代理

DAOS 代理是驻留在客户端节点上的守护进程，它与 DAOS 库交互以验证应用程序进程。它是一个受信任的实体，可以使用证书签署 DAOS 库凭据。代理可以支持不同的身份验证框架，并使用 Unix Domain Socket 与 DAOS 库进行通信。