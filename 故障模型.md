# 故障模型

DAOS 依赖于大规模分布式单端口存储。因此，每个目标实际上都是单点故障。DAOS 通过跨不同容错域中的目标提供冗余来实现数据和元数据的可用性和持久性。DAOS 内部池和容器元数据通过强大的共识算法进行复制。然后，通过在内部透明地利用 DAOS 分布式事务机制，安全地复制或擦除编码 DAOS 对象。本节的目的是提供有关 DAOS 如何实现容错并保证对象弹性的详细信息。



## 分层容错域

容错域是一组共享相同故障点的服务器，因此这些服务器可能会完全失败。DAOS 假定容错域是分层的，不会重叠。实际的层次结构和容错域成员身份必须由 DAOS 用于生成池映射的外部数据库提供。

池元数据从不同的高级容错域复制到多个节点上以实现高可用性，而对象数据可以根据所选对象类在可变数量的容错域上进行复制或纠删码。



## 故障检测

DAOS 引擎通过称为 [SWIM](https://doi.org/10.1109/DSN.2002.1028914) 的基于八卦的协议在 DAOS 系统内进行监控，该协议提供准确、高效和可扩展的故障检测。附加到每个 DAOS 目标的存储通过定期本地运行状况评估进行监控。每当本地存储 I/O 错误返回到 DAOS 服务器时，将自动调用内部健康检查过程。此过程将通过分析 IO 错误代码和设备 SMART/运行状况数据进行整体运行状况评估。如果结果为负，则目标将被标记为故障，并且到此目标的进一步 I/O 将被拒绝并重新路由。



## 故障隔离

检测到故障目标或引擎（实际上是一组目标）必须从池映射中排除。此过程由管理员手动或自动触发。排除后，新版本的池映射将急切地推送到所有存储目标。此时，存储池将进入降级模式，可能需要在访问时进行额外的处理（例如，从纠删码中重建数据）。因此，DAOS 客户机和存储节点会重试 RPC，直到它们从新的池映射中找到替代替换目标或遇到 RPC 超时。此时，与逐出目标的所有未完成通信都将中止，并且在显式重新集成目标之前（可能仅在维护操作之后），不应向目标发送进一步的消息。

池服务会及时通知所有存储目标池映射更改。客户端节点的情况并非如此，每次与任何引擎通信时，客户端节点都会延迟通知池映射失效。为此，客户端在每个 RPC 中打包其当前的池映射版本。服务器不仅使用当前的池映射版本进行回复。因此，当 DAOS 客户端遇到 RPC 超时时，它会定期与其他 DAOS 目标通信，以确保其池映射始终是最新的。然后，客户端最终将收到目标排除项的通知，并进入降级模式。

此机制保证全局节点逐出，并且所有节点最终共享相同的目标活动视图。



## 故障恢复

从池映射中排除后，每个目标都会自动启动重建过程以还原数据冗余。首先，每个目标创建一个受目标排除影响的本地对象列表。这是通过扫描由底层存储层维护的本地对象表来完成的。然后，对于每个受影响的对象，确定新对象分片的位置，并恢复整个历史记录（即快照）的对象冗余。重新生成所有受影响的对象后，将再次更新池映射，以将目标报告为失败。这标志着集体重建过程的结束，并退出了此特定故障的降级模式。此时，池已从故障中完全恢复，客户端节点现在可以从重建的对象分片中读取数据。

此重建过程在线执行，同时应用程序继续访问和更新对象。